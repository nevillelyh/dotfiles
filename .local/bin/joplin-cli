#!/bin/bash

# Launch joplin-cli
# See Docker files in .dotfiles/files/joplin-cli

set -euo pipefail

if ! type docker &> /dev/null; then
    echo "Docker not installed"
    exit 1
fi

image=nevillelyh/joplin-cli
arch=$(uname -m)
case $arch in
    aarch64)
        arch=arm64
        ;;
    x86_64)
        arch=amd64
        ;;
esac

file=$HOME/.cache/joplin-cli-update
(( ttl = 7 * 24 * 60 * 60 ))
if [[ -f "$file" ]]; then
    age=$(echo "$(date "+%s")" - "$(date -r "$file" "+%s")" | bc -l)
    if [[ $age -ge $ttl ]]; then
        docker pull -q $image:$arch > /dev/null
        touch "$file"
    fi
else
    docker pull -q $image:$arch
    touch "$file"
fi

mkdir -p "$HOME/.cache/joplin-cli"
cmd="docker run -it -v $HOME/.cache/joplin-cli:/home/joplin/.config/joplin --rm $image:$arch"
if tty &> /dev/null; then
    $cmd
else
    alacritty -e "$cmd"
fi
