#!/bin/bash

# Launch joplin
# See Docker files in .dotfiles/builds/joplin

set -euo pipefail

if [[ -f "$HOME/.dotfiles/files/bs.sh" ]]; then
    # shellcheck source=/dev/null
    source "$HOME/.dotfiles/files/bs.sh"
else
    eval "$(curl -fsSL https://raw.githubusercontent.com/nevillelyh/dotfiles/main/.dotfiles/files/bs.sh)"
fi

if ! type docker &> /dev/null; then
    echo "Docker not installed"
    exit 1
fi

image=nevillelyh/joplin:latest

file=$HOME/.cache/joplin-update
(( ttl = 7 * 24 * 60 * 60 ))
if [[ ! -f "$file" ]] || [[ $(bs_file_age "$file") -ge $ttl ]]; then
    docker pull -q "$image" > /dev/null
    touch "$file"
fi

mkdir -p "$HOME/.cache/joplin"
docker run -it --rm \
    -v "$HOME/.cache/joplin:/home/node/.config/joplin" \
    "$image" "$@"
