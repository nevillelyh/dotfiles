#!/bin/bash

# Upgrade .dotfiles and related packages

set -euo pipefail

if [[ -f "$HOME/.dotfiles/files/bs.sh" ]]; then
    # shellcheck source=/dev/null
    source "$HOME/.dotfiles/files/bs.sh"
else
    eval "$(curl -fsSL https://raw.githubusercontent.com/nevillelyh/dotfiles/main/.dotfiles/files/bs.sh)"
fi

cmd_os() {
    bs_info_box "Upgrading system packages"
    case "$BS_UNAME_S" in
        Darwin)
            brew update
            brew upgrade
            brew cleanup
            brew autoremove
            ;;
        Linux)
            sudo aptitude -y update
            sudo aptitude -y upgrade
            sudo aptitude -y autoclean
            sudo apt-get -y autoremove
            dpkg-query -l | grep '^rc' | awk '{print $2}' | xargs -r sudo aptitude -y purge || true
            type snap &> /dev/null || return 0
            sudo snap refresh
            ;;
    esac
}

cmd_git() {
    bs_info_box "Upgrading Git Repository"
    git pull --rebase --autostash
    git submodule update --init --recursive --remote
    for path in $(git submodule status  | grep '^[^ ]' | awk '{print $2}'); do
        git add "$path"
        local prefix
        if [[ $path == .config/awesome/* ]]; then
            prefix="[awesome]"
        else
            prefix="[zsh]"
        fi
        git commit --message "$prefix upgrade $(basename "$path")"
    done
    git push

    if [[ -d "$HOME/.dotfiles/private" ]] && curl -fsSL --connect-timeout 1 --output /dev/null fides.lan &> /dev/null; then
        cd "$HOME/.dotfiles/private"
        git pull --rebase --autostash
        git push
    fi
}

cmd_omz() {
    bs_info_box "Upgrading Oh-My-Zsh"
    zsh -i -c "omz update"
}

cmd_neovim() {
    bs_info_box "Upgrading NeoVim"
    nvim -u "$HOME/.config/nvim/dein.vim" --headless \
        '+let g:dein#install_progress_type = "none" | call dein#update() | echo "\r\n" | qall'
    if [[ -n "${TMUX-}" ]]; then
        nvim -u "$HOME/.config/nvim/dein.vim" --headless '+Tmuxline | qall'
    fi
}

cmd_docker() {
    type docker &> /dev/null || return 0
    bs_info_box "Upgrading Docker"
    for image in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v ':<none>' | grep -v '\.amazonaws\.com/'); do
        digest=$(docker inspect "$image" | jq --raw-output ".[].RepoDigests[]")
        platform=$(docker inspect "$image" | jq --raw-output '.[] | "\(.Os)/\(.Architecture)"')
        [[ -z "$digest" ]] || docker pull --platform "$platform" "$image"
    done
    docker images --quiet --filter dangling=true | xargs -r docker rmi

    joplin sync
}

cmd_go() {
    bs_info_box "Upgrading Go"
    if [[ -d /usr/local/go ]]; then
        os=$(echo "$BS_UNAME_S" | tr "[:upper:]" "[:lower:]")
        arch=$(dpkg --print-architecture)
        tarball=$(curl -fsSL "https://go.dev/dl" | grep -oP '(?<=href=")[^"]+(?=")' | grep "/dl/go.*\.$os-$arch\.tar\.gz" | tac | tail -n 1)
        latest=$(echo "$tarball" | sed "s/^\/dl\/\(go.*\)\.$os-$arch\.tar\.gz$/\1/")
        current=$(go version | awk '{ print $3 }')
        if [[ "$latest" != "$current" ]]; then
            read -p "Upgrade from $current to $latest (y/N)? " -n 1 -r
            echo # (optional) move to a new line
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                sudo rm -rf /usr/local/go
                "$HOME/.dotfiles/files/install.sh" go
            fi
        fi
    fi
    if [[ -d "$HOME/.go/bin" ]]; then
        for mod in $(go version -m "$HOME/.go/bin" | grep '^\s\+path\s\+' | awk '{print $2}'); do
            go install "$mod@latest"
        done
    fi
}

cmd_jvm() {
    bs_info_box "Upgrading JVM"
    "$HOME/.dotfiles/files/sdkman.sh"
}

cmd_python() {
    bs_info_box "Upgrading Python"
    python3 -m pip install --upgrade pip
    # Bash 3 on Mac missing readarray
    # shellcheck disable=SC2207
    pip_pkgs=($(grep '^PIP_PKGS=(' "$HOME/.dotfiles/files/bootstrap.sh" | sed 's/^PIP_PKGS=(\(.*\))$/\1/'))
    python3 -m pip install --upgrade "${pip_pkgs[@]}"
}

cmd_rust() {
    bs_info_box "Upgrading Rust"
    rustup update
    # Bash 3 on Mac missing readarray
    if [[ -s "$HOME/.cargo/.crates.toml" ]]; then
        # shellcheck disable=SC2207
        crates=($(grep '^"[^"]*" = \["[^"]*"\]$' "$HOME/.cargo/.crates.toml" | sed 's/^"\([^ ]*\) .*$/\1/'))
        cargo install -q "${crates[@]}"
    fi
}

cmd_anaconda() {
    type conda &> /dev/null || return 0
    bs_info_box "Upgrading Anaconda"
    conda update --all --name base --yes
}

upgrade() {
    cd "$HOME"
    cmd_os
    cmd_git
    cmd_omz
    cmd_neovim
    cmd_docker
    cmd_go
    cmd_jvm
    cmd_python
    cmd_rust
    cmd_anaconda
    bs_success_box "Upgrade complete"
}

bs_cmd_optional upgrade "$@"
