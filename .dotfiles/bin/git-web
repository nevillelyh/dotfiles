#!/bin/bash

# Open a file in Git web UI

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: $(basename "$0") [file]..."
    exit 1
fi

dir=$(git rev-parse --show-toplevel)
url=$(git config --get remote.origin.url)
ref=$(git symbolic-ref --quiet HEAD)
ref=${ref#refs/heads/}

# url="git@hostname.com:username/repo.git"
# url="https://hostname.com/username/repo.git"
# url="ssh://user@hostname.com:12345/repo.git"
re="^(https://|ssh://)?([^@]+@)?([^\/:]+)(:[[:digit:]]+\/|:|\/)?(.+)$"
if [[ $url =~ $re ]]; then
    # protocol=${BASH_REMATCH[1]}
    # username=${BASH_REMATCH[2]}
    hostname=${BASH_REMATCH[3]}
    # port=${BASH_REMATCH[4]}
    repo=${BASH_REMATCH[5]}
fi
repo=${repo/%.git}

case "$hostname" in
    "github.com")
        prefix="https://$hostname/$repo/tree"
        ;;
    *)
        echo "Unsupported host: $hostname"
        exit 1
        ;;
esac

for path in "$@"; do
    path=$(readlink -f "$path")
    path=${path/#$dir}
    path=${path/#\/}
    open "$prefix/$ref/$path"
done
