#!/bin/zsh

set -euo pipefail

msg_box() {
    LINE="##$(echo "$1" | sed 's/./#/g')##"
    echo "$LINE"
    echo "# $1 #"
    echo "$LINE"
}

cd $HOME

msg_box "Upgrading system packages"
case "$(uname -s)" in
    Darwin)
        brew update
        brew upgrade
        brew cleanup
        brew autoremove
        ;;
    Linux)
        sudo aptitude update
        sudo aptitude upgrade
        sudo aptitude autoclean
        sudo apt-get autoremove
        ;;
esac

msg_box "Upgrading Git Repository"
git pull --rebase --autostash
git submodule update --init --remote

msg_box "Upgrading Oh-My-Zsh"
set +eu
source "$HOME/.dotfiles/oh-my-zsh/oh-my-zsh.sh"
omz update
set -euo pipefail

msg_box "Upgrading NeoVim"
VS='+let g:dein#install_progress_type = "none" | call dein#update() | echo "\r\n" | qall'
nvim -u $HOME/.config/nvim/dein.vim --headless $VS

msg_box "Upgrading Python Packages"
PIP_PKGS=$(grep '^PIP_PKGS="' $HOME/.dotfiles/files/bootstrap.sh | sed 's/^PIP_PKGS="\(.*\)"$/\1/')
pip3 install --quiet --upgrade --upgrade-strategy eager ${=PIP_PKGS}

msg_box "Upgrading Rust"
rustup update
CRATES=$(grep '^"[^"]*" = \["[^"]*"\]$' $HOME/.cargo/.crates.toml | sed 's/^"\([^ ]*\) .*$/\1/')
cargo install -q ${=CRATES}

msg_box "Upgrading SDKMAN"
set +eu
source "$HOME/.sdkman/bin/sdkman-init.sh"
sdk update
sdk upgrade
set -euo pipefail
